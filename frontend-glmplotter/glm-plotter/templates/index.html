<!DOCTYPE html>
<meta charset="utf-8">
<head><link rel="stylesheet" href="static/css/style.css"></head>
<style>body { font: 12px Arial;}</style>
<body>

<div id="gridlabdControls">
	<h3>GridLAB-D Simulation</h3>
<div id="gridlabdControls">
	<h3>Step 1: Run GridLAB-D Simulation</h3>
	<div>
		<label for="simulationFileInput">Select GLM file:</label>
		<input type="file" id="simulationFileInput" accept=".glm" style="margin: 5px 0;" />
	</div>
	<div>
		<label for="randomseed">Random Seed:</label>
		<input type="number" id="randomseed" value="42" />
	</div>
	<div style="margin-top: 10px;">
		<button onclick="runSimulationOnSelectedFile()" style="background-color: #2196F3; font-size: 16px; padding: 10px 20px;">üöÄ Run Simulation</button>
	</div>
	<div id="simulationResult" style="margin-top: 10px;"></div>
</div>

<div id="visualizationControls">
	<h3>Step 2: Load Results for Visualization</h3>
	<div>
		<label for="cacheFileSelect">Select result file from cache:</label>
		<select id="cacheFileSelect" style="margin: 5px 10px; padding: 5px; min-width: 300px;">
			<option value="">-- Select file to visualize --</option>
		</select>
		<button onclick="loadCacheFiles()" style="background-color: #2196F3; padding: 5px 10px;">üîÑ Refresh</button>
	</div>
	<div style="margin-top: 10px;">
		<button onclick="loadSelectedCacheFile()" style="background-color: #4CAF50; font-size: 16px; padding: 10px 20px;">üìä Load for Visualization</button>
	</div>
</div>

<div id="main"></div>
<script src="static/lib/js/d3.js"></script>

<script src="static/js/plotNetwork.js"></script>



<!--
<div>
Legend:
<ul class="legend">
    <li><span class="overhead"></span> Overhead Line</li>
    <li><span class="underground"></span> Underground Line</li>
    <li><span class="sw"></span> Switch</li>
	<li><span class="reg"></span> Regulator</li>
    <li><span class="trans"></span> Transformer</li>
</ul>
</div>
<div id="chart" style="display:none;"> Hidden chart</div>

-->

<!--
    This was to add a chart that I can update interactively. Am not sure what I want to put in that chart yet.
<script src="chart.js"></script>

-->
<div>
	<h2>Options</h2>
<div id="option">
    <input name="saveButton" 
           type="button" 
           value="save XY coords of all nodes" 
           onclick="saveXY()" />
</div>
<div id="option">
    <input name="saveFixedButton" 
           type="button" 
           value="save XY coords of fixed nodes" 
           onclick="saveXYfixed()" />
</div>
<div id="prefixRemover">
	<input name="prefixRemoverTxt" 
		id="rmPreText"
		type="text" 
		value="" />
    <input name="prefixRemoverButton" 
		type="button" 
		value="remove prefix in node names" 
		onclick="removePrefix()" />
<div id="nodeSearch">
	<input name="nodeSearchTxt" 
		id="nodeSearchNm"
		type="text" 
		value="Enter node nm"  />
    <input name="searchNodeButton" 
		type="button" 
		value="search" 
		onclick="nodeSearcher()" />
</div>
<div id="gravityChooser">
	<input name="garvityTxt" 
		id="gravityVal"
		type="text" 
		value="0.05"  />
    <input name="gravityButton" 
		type="button" 
		value="change gravity" 
		onclick="changeGravity()" />
</div>
<form action="/" method="post" enctype="multipart/form-data">
    <input type="file" name="fixedNodes" />
    <input type="submit" value="Submit fixed positions csv"/>
</form>
</div>

<!-- footer-->      
  <div id="footer-wrap"><div id="footer">        
      
      <p>
      &copy; 2016-2019 Jacques de Chalendar - Released under the MIT License.
      </p>
      
  </div></div>

<script>
function loadCacheFiles() {
    const cacheSelect = document.getElementById('cacheFileSelect');
    
    fetch('/list_cache_files')
    .then(response => response.json())
    .then(data => {
        // Clear existing options except the first one
        cacheSelect.innerHTML = '<option value="">-- Select cached file --</option>';
        
        if (data.files && data.files.length > 0) {
            data.files.forEach(file => {
                const option = document.createElement('option');
                option.value = file.name;
                const modifiedDate = new Date(file.modified * 1000).toLocaleString();
                option.textContent = `${file.name} (${(file.size/1024).toFixed(1)}KB - ${modifiedDate})`;
                cacheSelect.appendChild(option);
            });
        }
    })
    .catch(error => {
        console.error('Error loading cache files:', error);
        // Add error option
        const errorOption = document.createElement('option');
        errorOption.value = '';
        errorOption.textContent = 'Error loading cache files';
        errorOption.disabled = true;
        cacheSelect.appendChild(errorOption);
    });
}

function runSimulationOnSelectedFile() {
    const fileInput = document.getElementById('simulationFileInput');
    const randomseed = document.getElementById('randomseed').value;
    const resultDiv = document.getElementById('simulationResult');
    
    // Check if a file is selected from computer
    if (!fileInput.files.length) {
        alert('Please select a GLM file from your computer.');
        return;
    }
    
    const selectedFile = fileInput.files[0];
    
    // Check if it's a GLM file
    if (!selectedFile.name.toLowerCase().endsWith('.glm')) {
        alert('Please select a valid GLM file.');
        return;
    }
    
    resultDiv.innerHTML = `<p>Running GridLAB-D simulation on ${selectedFile.name}...</p>`;
    
    // Create form data with the selected file
    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('randomseed', randomseed);
    
    // Send to the run_gridlabd_with_file endpoint
    fetch('/run_gridlabd_with_file', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let html = '<div style="color: green;"><strong>‚úÖ Simulation completed successfully!</strong></div>';
            if (data.output_files && data.output_files.length > 0) {
                html += '<p><strong>Output files generated:</strong></p>';
                html += '<ul>';
                data.output_files.forEach(file => {
                    html += `<li>${file}</li>`;
                });
                html += '</ul>';
                html += '<p><em>üí° Go to Step 2 and click "Refresh" to load these results for visualization.</em></p>';
            }
            if (data.stdout) {
                html += '<details><summary>GridLAB-D Output</summary><pre>' + data.stdout + '</pre></details>';
            }
            resultDiv.innerHTML = html;
            // Refresh cache files list for Step 2
            loadCacheFiles();
        } else {
            let html = '<div style="color: red;"><strong>‚ùå Simulation failed!</strong></div>';
            if (data.stderr) {
                html += '<p><strong>Error:</strong></p><pre>' + data.stderr + '</pre>';
            }
            if (data.stdout) {
                html += '<p><strong>Output:</strong></p><pre>' + data.stdout + '</pre>';
            }
            resultDiv.innerHTML = html;
        }
    })
    .catch(error => {
        resultDiv.innerHTML = '<div style="color: red;">Error: ' + error.message + '</div>';
    });
}

function loadSelectedCacheFile() {
    const cacheSelect = document.getElementById('cacheFileSelect');
    
    if (!cacheSelect.value) {
        alert('Please select a file from the cache first.');
        return;
    }
    
    // Load from cache
    fetch('/load_cache_file', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ filename: cacheSelect.value })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ File loaded successfully: ' + data.filename);
            // Refresh the visualization
            window.location.reload();
        } else {
            alert('‚ùå Error loading file: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Error: ' + error.message);
    });
}

// Load cache files on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCacheFiles();
});
</script>
 

</body>
</html>
